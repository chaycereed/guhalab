---
title: "NHANES Mental Health Workflow"
format: html
editor: visual
---

# Overview

This workflow provides a reproducible example of analyzing mental-health-related variables from NHANES. It includes:

-   Importing NHANES data
-   Cleaning and preprocessing variables
-   Scoring mental health scales (e.g., PHQ-9)
-   Running exploratory analyses
-   Creating reusable visualizations

```{r}
library(tidyverse)
library(haven)
library(nhanesA)
```

```{r}
source("../R/load_nhanes.R")
source("../R/clean_variables.R")
source("../R/score_scales.R")
source("../R/viz_templates.R")
```

# Load Data

```{r}
nhanes_variables <- paste0("DPQ0", c(10, 20, 30, 40, 50, 60, 70, 80, 90))
nhanes_cycles <- c("2015-2016", "2017-2018")

df_raw <- load_nhanes(
  variables   = nhanes_variables,
  cycles      = nhanes_cycles,
  use_nhanesA = TRUE  # change to TRUE for nhanesA-based loading
)

head(df_raw)
```

# Clean Variables

```{r}
df_clean <- clean_variables(df_raw)
head(df_clean)
```

# Score Scales

```{r}
df_scored <- score_scales(df_clean)
head(df_scored)

dplyr::count(df_scored, phq9_severity)
```

# Exploratory Analysis

```{r}
df_scored |>
  ggplot(aes(x = phq9_score)) +
  geom_histogram(binwidth = 1, fill = "steelblue", alpha = 0.7) +
  labs(
    title = "Distribution of PHQ-9 Depression Scores",
    x = "PHQ-9 Score",
    y = "Count"
  ) +
  viz_theme()
```

```{r}
df_scored |>
  filter(!is.na(phq9_severity)) |>
  ggplot(aes(x = phq9_severity)) +
  geom_bar(fill = "darkorange", alpha = 0.8) +
  labs(
    title = "PHQ-9 Severity Category Distribution",
    x = "Severity",
    y = "Count"
  ) +
  viz_theme()
```

```{r}
df_scored |>
  filter(!is.na(phq9_severity)) |>
  ggplot(aes(x = cycle, fill = phq9_severity)) +
  geom_bar(position = "fill") +
  labs(
    title = "Severity Distribution by NHANES Cycle",
    y = "Proportion",
    x = "Cycle",
    fill = "Severity"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  viz_theme()
```